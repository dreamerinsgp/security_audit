# 调试 Agave 源码 - CPI 验证日志

本文档说明如何在 agave 源码中添加和使用日志来调试 CPI（Cross-Program Invocation）验证流程。

## 已添加的日志位置

### 1. CPI 入口日志 (`agave/program-runtime/src/cpi.rs:cpi_common`)

在 `cpi_common` 函数中添加了以下日志：

```rust
// 记录 signer seeds 转换开始
ic_msg!(
    invoke_context,
    "[CPI DEBUG] Starting signer translation - program_id: {}, signers_seeds_len: {}",
    caller_program_id,
    signers_seeds_len
);

// 记录派生出的 signers
ic_msg!(
    invoke_context,
    "[CPI DEBUG] Derived {} signer(s) from seeds: {:?}",
    signers.len(),
    signers
);

// 记录准备指令的详细信息
ic_msg!(
    invoke_context,
    "[CPI DEBUG] Preparing instruction - program_id: {}, num_accounts: {}, signers_count: {}",
    instruction.program_id,
    instruction.accounts.len(),
    signers.len()
);
```

### 2. PDA 派生日志 (`agave/program-runtime/src/cpi.rs:translate_signers_c`)

在 `translate_signers_c` 函数中添加了 `eprintln!` 日志：

```rust
eprintln!(
    "[CPI DEBUG] translate_signers_c: Signer {} - Derived PDA: {} from {} seed(s) with program_id: {}",
    idx,
    pda,
    seeds_bytes.len(),
    program_id
);
```

### 3. Signer 验证日志 (`agave/program-runtime/src/invoke_context.rs:prepare_next_instruction`)

在 signer 验证部分添加了详细日志：

```rust
ic_msg!(
    self,
    "[SIGNER VERIFY] Account {} - is_signer in callee: true, is_signer in caller: {}, in signers list: {}, signers list: {:?}",
    account_key,
    is_caller_signer,
    is_in_signers_list,
    signers
);

// 验证通过时
ic_msg!(
    self,
    "[SIGNER VERIFY] Account {} signer verification PASSED",
    account_key
);
```

## 如何使用这些日志

### 方法1：使用本地 agave 节点

1. **启动 agave 节点：**
   ```bash
   cd /root/solana-security-audit
   ./start-agave-node.sh
   ```

2. **在另一个终端运行测试：**
   ```bash
   export ANCHOR_PROVIDER_URL="http://localhost:8899"
   anchor test --skip-local-validator
   ```

3. **查看验证器日志：**
   ```bash
   # 查看所有日志
   tail -f test-ledger/validator.log
   
   # 只查看 CPI 相关日志
   tail -f test-ledger/validator.log | grep -E "CPI DEBUG|SIGNER VERIFY|SEEDS->PDA"
   ```

### 方法2：使用 GDB 调试

1. **启动带调试符号的节点：**
   ```bash
   cd /root/solana-security-audit/agave
   cargo build --release
   gdb --args ./target/release/solana-test-validator --rpc-port 8899 --reset
   ```

2. **在 GDB 中设置断点：**
   ```gdb
   (gdb) break cpi_common
   (gdb) break translate_signers_c
   (gdb) break prepare_next_instruction
   (gdb) run
   ```

3. **查看日志输出：**
   - `eprintln!` 输出会显示在 GDB 的标准错误输出中
   - `ic_msg!` 输出会出现在交易日志中

### 方法3：在测试代码中查看交易日志

```typescript
// 在测试中执行交易
const tx = await program.methods.initializeLaunch({})
  .accounts({
    launch: launchPda,
    launchSigner: launchSignerPda,
    creator: creator.publicKey,
    tokenVault: tokenVaultPda,
    tokenMint: tokenMint.publicKey,
    tokenProgram: TOKEN_PROGRAM_ID,
    associatedTokenProgram: ASSOCIATED_TOKEN_PROGRAM_ID,
    systemProgram: SystemProgram.programId,
  })
  .rpc();

// 获取交易详情（包含日志）
const txDetails = await provider.connection.getTransaction(tx, {
  commitment: 'confirmed',
  maxSupportedTransactionVersion: 0
});

// 打印日志
console.log('Transaction logs:');
txDetails?.meta?.logMessages?.forEach(log => {
  if (log.includes('CPI DEBUG') || log.includes('SIGNER VERIFY')) {
    console.log(log);
  }
});
```

## 日志输出示例

运行测试时，您应该看到类似以下的日志：

```
[CPI DEBUG] Starting signer translation - program_id: <program_id>, signers_seeds_len: 1
[CPI DEBUG] translate_signers_c: Signer 0 - Derived PDA: <pda_address> from 3 seed(s) with program_id: <program_id>
[CPI DEBUG] Derived 1 signer(s) from seeds: [<pda_address>]
[CPI DEBUG] Preparing instruction - program_id: <token_program_id>, num_accounts: 3, signers_count: 1
[SIGNER VERIFY] Account <authority_account> - is_signer in callee: true, is_signer in caller: false, in signers list: true, signers list: [<pda_address>]
[SIGNER VERIFY] Account <authority_account> signer verification PASSED
```

## 调试技巧

1. **过滤日志：** 使用 `grep` 过滤特定类型的日志
2. **设置日志级别：** 使用 `RUST_LOG=debug` 环境变量启用更详细的日志
3. **断点调试：** 在关键函数处设置断点，逐步执行
4. **对比预期：** 将实际派生的 PDA 与预期的 PDA 进行对比

## 相关文件

- `agave/program-runtime/src/cpi.rs` - CPI 相关代码
- `agave/program-runtime/src/invoke_context.rs` - 指令执行上下文
- `programs/solana-security-audit/src/instructions/initializeLaunch.rs` - 使用 CPI 的程序代码
- `lessons/concepts/3.cpi验证.md` - CPI 验证原理说明

## 注意事项

1. `eprintln!` 日志会输出到标准错误，在验证器日志中可见
2. `ic_msg!` 日志会出现在交易日志中，可通过 RPC 获取
3. 日志可能会影响性能，生产环境建议移除或使用条件编译
4. 确保使用 debug 或 release 构建，以便看到完整的日志信息

