# PDA Signer å’Œ Authority è´¦æˆ·æ ¡éªŒé€»è¾‘è¯¦è§£

## æ¦‚è¿°

å½“ä½¿ç”¨ `CpiContext::new_with_signer` æˆ– `invoke_signed` è¿›è¡Œ CPI è°ƒç”¨æ—¶ï¼ŒSolana runtime ä¼šéªŒè¯ï¼š
1. ä» `signer_seeds` æ´¾ç”Ÿçš„ PDA åœ°å€
2. ä¼ å…¥çš„ `authority` è´¦æˆ·åœ°å€æ˜¯å¦åŒ¹é…

## å®Œæ•´éªŒè¯æµç¨‹

### 1. Seeds è½¬ PDA åœ°å€ (`agave/program-runtime/src/cpi.rs`)

#### Rust ç¨‹åºè°ƒç”¨è·¯å¾„
**æ–‡ä»¶**: `agave/program-runtime/src/cpi.rs:619-661`

```rust
pub fn translate_signers_rust(
    program_id: &Pubkey,
    signers_seeds_addr: u64,
    signers_seeds_len: u64,
    memory_mapping: &MemoryMapping,
    check_aligned: bool,
) -> Result<Vec<Pubkey>, Error> {
    // ...
    for signer_seeds in signers_seeds.iter() {
        // å°† seeds è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
        let seeds = untranslated_seeds
            .iter()
            .map(|untranslated_seed| {
                translate_vm_slice(untranslated_seed, memory_mapping, check_aligned)
            })
            .collect::<Result<Vec<_>, Error>>()?;
        
        // ğŸ”‘ å…³é”®æ­¥éª¤ï¼šä½¿ç”¨ program_id + seeds æ´¾ç”Ÿ PDA åœ°å€
        let signer = Pubkey::create_program_address(&seeds, program_id)
            .map_err(CpiError::BadSeeds)?;
        signers.push(signer);
    }
    Ok(signers)  // è¿”å› PDA åœ°å€åˆ—è¡¨
}
```

#### C ç¨‹åºè°ƒç”¨è·¯å¾„
**æ–‡ä»¶**: `agave/program-runtime/src/cpi.rs:757-799`

```rust
pub fn translate_signers_c(
    program_id: &Pubkey,
    signers_seeds_addr: u64,
    signers_seeds_len: u64,
    memory_mapping: &MemoryMapping,
    check_aligned: bool,
) -> Result<Vec<Pubkey>, Error> {
    // ...
    Ok(signers_seeds
        .iter()
        .map(|signer_seeds| {
            // å°† seeds è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
            let seeds_bytes = seeds
                .iter()
                .map(|seed| {
                    translate_slice::<u8>(memory_mapping, seed.addr, seed.len, check_aligned)
                })
                .collect::<Result<Vec<_>, Error>>()?;
            
            // ğŸ”‘ å…³é”®æ­¥éª¤ï¼šä½¿ç”¨ program_id + seeds æ´¾ç”Ÿ PDA åœ°å€
            Pubkey::create_program_address(&seeds_bytes, program_id)
                .map_err(|err| Box::new(CpiError::BadSeeds(err)) as Error)
        })
        .collect::<Result<Vec<_>, Error>>()?)
}
```

**å…³é”®ç‚¹**:
- ä½¿ç”¨ `Pubkey::create_program_address(&seeds, program_id)` æ´¾ç”Ÿ PDA
- è¿”å› `Vec<Pubkey>`ï¼ŒåŒ…å«æ‰€æœ‰ä» seeds æ´¾ç”Ÿçš„ PDA åœ°å€
- è¿™ä¸ªåˆ—è¡¨ä¼šè¢«ä¼ é€’ç»™ `prepare_next_instruction` ä½œä¸º `signers` å‚æ•°

### 2. CPI è°ƒç”¨å…¥å£ (`agave/program-runtime/src/cpi.rs:802-846`)

```rust
pub fn cpi_common<S: SyscallInvokeSigned>(
    invoke_context: &mut InvokeContext,
    instruction_addr: u64,
    account_infos_addr: u64,
    account_infos_len: u64,
    signers_seeds_addr: u64,
    signers_seeds_len: u64,
    memory_mapping: &mut MemoryMapping,
) -> Result<u64, Error> {
    // 1. ç¿»è¯‘æŒ‡ä»¤
    let instruction = S::translate_instruction(...)?;
    
    // 2. è·å–è°ƒç”¨è€…ç¨‹åº ID
    let caller_program_id = instruction_context.get_program_key()?;
    
    // 3. ğŸ”‘ å°† signer_seeds è½¬æ¢ä¸º PDA åœ°å€åˆ—è¡¨
    let signers = S::translate_signers(
        caller_program_id,  // ä½¿ç”¨è°ƒç”¨è€…ç¨‹åº ID
        signers_seeds_addr,
        signers_seeds_len,
        memory_mapping,
        check_aligned,
    )?;
    
    // 4. ğŸ”‘ å‡†å¤‡ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œä¼ å…¥ signers åˆ—è¡¨è¿›è¡ŒéªŒè¯
    invoke_context.prepare_next_instruction(instruction, &signers)?;
    
    // ...
}
```

### 3. Authority è´¦æˆ· Signer æƒé™éªŒè¯ (`agave/program-runtime/src/invoke_context.rs:294-433`)

**æ–‡ä»¶**: `agave/program-runtime/src/invoke_context.rs:394-401`

```rust
pub fn prepare_next_instruction(
    &mut self,
    instruction: Instruction,
    signers: &[Pubkey],  // ä» signer_seeds æ´¾ç”Ÿçš„ PDA åœ°å€åˆ—è¡¨
) -> Result<(), InstructionError> {
    // ...
    
    for current_index in 0..instruction_accounts.len() {
        let instruction_account = instruction_accounts.get(current_index).unwrap();
        let account_key = &instruction.accounts.get(current_index).unwrap().pubkey;
        
        // è·å–è°ƒç”¨è€…æŒ‡ä»¤ä¸­çš„è´¦æˆ·ä¿¡æ¯
        let caller_instruction_account = instruction_context
            .instruction_accounts()
            .get(index_in_caller as usize)
            .unwrap();
        
        // ğŸ”‘ å…³é”®éªŒè¯ï¼šæ£€æŸ¥è´¦æˆ·æ˜¯å¦éœ€è¦ç­¾å
        if instruction_account.is_signer() {
            // è´¦æˆ·å¿…é¡»æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€ï¼š
            // 1. åœ¨è°ƒç”¨è€…æŒ‡ä»¤ä¸­å·²ç»æ˜¯ signer
            // 2. åœ¨ signers åˆ—è¡¨ä¸­ï¼ˆå³ä» signer_seeds æ´¾ç”Ÿçš„ PDA åœ°å€ï¼‰
            if !(caller_instruction_account.is_signer() || signers.contains(account_key)) {
                ic_msg!(self, "{}'s signer privilege escalated", account_key,);
                return Err(InstructionError::PrivilegeEscalation);
            }
        }
    }
    
    // ...
}
```

**éªŒè¯é€»è¾‘**:
- å¯¹äºæ¯ä¸ªæ ‡è®°ä¸º `is_signer()` çš„è´¦æˆ·ï¼ˆå¦‚ `authority`ï¼‰
- æ£€æŸ¥è¯¥è´¦æˆ·çš„ `pubkey` æ˜¯å¦åœ¨ `signers` åˆ—è¡¨ä¸­
- `signers` åˆ—è¡¨åŒ…å«ä» `signer_seeds` æ´¾ç”Ÿçš„æ‰€æœ‰ PDA åœ°å€
- å¦‚æœ `authority` è´¦æˆ·çš„åœ°å€ä¸æŸä¸ª PDA åœ°å€åŒ¹é…ï¼ŒéªŒè¯é€šè¿‡
- å¦åˆ™è¿”å› `InstructionError::PrivilegeEscalation` é”™è¯¯

## å®é™…æ¡ˆä¾‹ï¼šinitializeLaunch.rs

### ä»£ç æµç¨‹

```rust
// 1. æ‰‹åŠ¨æ´¾ç”Ÿ PDA
let (launch_signer, launch_signer_pda_bump) = Pubkey::find_program_address(
    &[b"launch_signer", ctx.accounts.launch.key().as_ref()],
    ctx.program_id,
);

// 2. åˆ›å»º signer_seeds
let seeds = &[
    b"launch_signer",
    launch_key.as_ref(),
    &[launch_signer_pda_bump],
];
let signer_seeds: &[&[&[u8]]] = &[&seeds[..]];

// 3. CPI è°ƒç”¨ï¼Œä½¿ç”¨ signer_seeds
token::mint_to(
    CpiContext::new_with_signer(
        ctx.accounts.token_program.to_account_info(),
        MintTo {
            mint: ctx.accounts.token_mint.to_account_info(),
            to: ctx.accounts.token_vault.to_account_info(),
            authority: ctx.accounts.launch_signer.to_account_info(),  // authority è´¦æˆ·
        },
        signer_seeds,  // PDA seeds
    ),
    AVAILABLE_TOKENS,
)?;
```

### éªŒè¯æ­¥éª¤

1. **Runtime æ¥æ”¶ signer_seeds**:
   ```
   signer_seeds = [
       [b"launch_signer", launch_key.as_ref(), [bump]]
   ]
   ```

2. **translate_signers æ´¾ç”Ÿ PDA**:
   ```rust
   // åœ¨ cpi.rs ä¸­
   let derived_pda = Pubkey::create_program_address(
       &[b"launch_signer", launch_key.as_ref(), [bump]],
       caller_program_id  // ctx.program_id
   )?;
   signers = vec![derived_pda];  // ä¾‹å¦‚: [9dD2pVMKDUHWkdUjsuaM4G3eYb1PMXk13vVXeaeKqitJ]
   ```

3. **prepare_next_instruction éªŒè¯ authority**:
   ```rust
   // åœ¨ invoke_context.rs ä¸­
   let authority_key = ctx.accounts.launch_signer.key();  // ä¾‹å¦‚: 9dD2pVMKDUHWkdUjsuaM4G3eYb1PMXk13vVXeaeKqitJ
   
   // æ£€æŸ¥ authority æ˜¯å¦åœ¨ signers åˆ—è¡¨ä¸­
   if instruction_account.is_signer() {
       if !signers.contains(&authority_key) {
           return Err(InstructionError::PrivilegeEscalation);
       }
   }
   ```

4. **éªŒè¯ç»“æœ**:
   - âœ… **é€šè¿‡**: å¦‚æœ `authority_key == derived_pda`ï¼ŒéªŒè¯é€šè¿‡
   - âŒ **å¤±è´¥**: å¦‚æœ `authority_key != derived_pda`ï¼Œè¿”å› `PrivilegeEscalation` é”™è¯¯

## å…³é”®å‘ç°

### 1. éªŒè¯æ˜¯è‡ªåŠ¨çš„
- Solana runtime **è‡ªåŠ¨**éªŒè¯ PDA signer
- ä¸éœ€è¦åœ¨ç¨‹åºä»£ç ä¸­æ‰‹åŠ¨éªŒè¯ `authority` æ˜¯å¦åŒ¹é… PDA
- ä½†ç¨‹åºä»£ç ä¸­ä»åº”éªŒè¯è´¦æˆ·åœ°å€ï¼Œä»¥é˜²æ­¢é€»è¾‘é”™è¯¯

### 2. éªŒè¯å‘ç”Ÿåœ¨ CPI è°ƒç”¨æ—¶
- éªŒè¯å‘ç”Ÿåœ¨ `invoke_context.prepare_next_instruction()` ä¸­
- åœ¨è°ƒç”¨è¢«è°ƒç”¨ç¨‹åºä¹‹å‰è¿›è¡ŒéªŒè¯
- å¦‚æœéªŒè¯å¤±è´¥ï¼Œæ•´ä¸ªäº¤æ˜“ä¼šå¤±è´¥

### 3. éªŒè¯åŸºäºåœ°å€åŒ¹é…
- ä½¿ç”¨ `signers.contains(account_key)` è¿›è¡ŒåŒ¹é…
- åªè¦ `authority` è´¦æˆ·çš„åœ°å€ä¸ä» `signer_seeds` æ´¾ç”Ÿçš„ PDA åœ°å€åŒ¹é…å³å¯
- ä¸æ£€æŸ¥è´¦æˆ·çš„æ‰€æœ‰è€…ã€æ•°æ®ç­‰

### 4. æ½œåœ¨çš„å®‰å…¨é—®é¢˜
- å¦‚æœç¨‹åºä»£ç ä¸­æ‰‹åŠ¨æ´¾ç”Ÿçš„ PDA ä¸ `signer_seeds` ä¸ä¸€è‡´ï¼Œå¯èƒ½å¯¼è‡´éªŒè¯å¤±è´¥
- å¦‚æœ `authority` è´¦æˆ·åœ°å€ä¸ PDA ä¸åŒ¹é…ï¼Œä¼šå¯¼è‡´ `PrivilegeEscalation` é”™è¯¯
- ä½¿ç”¨ `UncheckedAccount` æ—¶ï¼Œéœ€è¦ç¡®ä¿è´¦æˆ·åœ°å€æ­£ç¡®

## ç›¸å…³ä»£ç ä½ç½®

1. **Seeds è½¬ PDA**:
   - Rust: `agave/program-runtime/src/cpi.rs:654`
   - C: `agave/program-runtime/src/cpi.rs:792`

2. **CPI å…¥å£**:
   - `agave/program-runtime/src/cpi.rs:802-846`

3. **Signer éªŒè¯**:
   - `agave/program-runtime/src/invoke_context.rs:396-401`

4. **PDA æ´¾ç”Ÿå‡½æ•°**:
   - `Pubkey::create_program_address()` (Solana SDK)

## æ€»ç»“

Solana runtime çš„ PDA signer éªŒè¯æµç¨‹ï¼š

1. **è¾“å…¥**: `signer_seeds` + `program_id`
2. **æ´¾ç”Ÿ**: ä½¿ç”¨ `create_program_address(seeds, program_id)` ç”Ÿæˆ PDA åœ°å€åˆ—è¡¨
3. **éªŒè¯**: æ£€æŸ¥ `authority` è´¦æˆ·åœ°å€æ˜¯å¦åœ¨ PDA åœ°å€åˆ—è¡¨ä¸­
4. **ç»“æœ**: åŒ¹é…åˆ™é€šè¿‡ï¼Œå¦åˆ™è¿”å› `PrivilegeEscalation` é”™è¯¯

è¿™ä¸ªéªŒè¯æœºåˆ¶ç¡®ä¿äº†åªæœ‰æ­£ç¡®çš„ PDA æ‰èƒ½ä½œä¸º signer è¿›è¡Œ CPI è°ƒç”¨ï¼Œé˜²æ­¢æƒé™æå‡æ”»å‡»ã€‚

