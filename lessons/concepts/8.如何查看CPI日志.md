# å¦‚ä½•æŸ¥çœ‹ CPI è°ƒè¯•æ—¥å¿—

## é—®é¢˜ï¼šä¸ºä»€ä¹ˆçœ‹ä¸åˆ°æ—¥å¿—ï¼Ÿ

æ—¥å¿—å·²ç»æ·»åŠ åˆ°ä»£ç ä¸­ï¼Œä½†éœ€è¦ï¼š
1. **é‡æ–°ç¼–è¯‘ agave éªŒè¯å™¨**
2. **æ­£ç¡®æŸ¥çœ‹æ—¥å¿—ä½ç½®**

## æ­¥éª¤ 1: é‡æ–°ç¼–è¯‘ agave éªŒè¯å™¨

```bash
cd /root/solana-security-audit/agave
cargo build --release
# æˆ–è€…ä½¿ç”¨ debug ç‰ˆæœ¬ï¼ˆåŒ…å«æ›´å¤šè°ƒè¯•ä¿¡æ¯ï¼‰
cargo build
```

## æ­¥éª¤ 2: å¯åŠ¨éªŒè¯å™¨ï¼ˆä½¿ç”¨æ›´æ–°åçš„è„šæœ¬ï¼‰

```bash
cd /root/solana-security-audit
./start-agave-node.sh
```

è¿™ä¸ªè„šæœ¬ç°åœ¨ä¼šå°†æ ‡å‡†é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ° `test-ledger/validator-stderr.log`

## æ­¥éª¤ 3: æŸ¥çœ‹æ—¥å¿—çš„æ–¹æ³•

### æ–¹æ³• 1: ä½¿ç”¨æŸ¥çœ‹è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
./view-cpi-logs.sh
```

### æ–¹æ³• 2: æ‰‹åŠ¨æŸ¥çœ‹æ ‡å‡†é”™è¯¯æ—¥å¿—

```bash
# æŸ¥çœ‹ eprintln! è¾“å‡ºï¼ˆåœ¨æ ‡å‡†é”™è¯¯æ—¥å¿—ä¸­ï¼‰
tail -f test-ledger/validator-stderr.log | grep -E "CPI DEBUG|SIGNER VERIFY"

# æˆ–è€…æŸ¥çœ‹æ‰€æœ‰æ ‡å‡†é”™è¯¯æ—¥å¿—
tail -f test-ledger/validator-stderr.log
```

### æ–¹æ³• 3: åœ¨æµ‹è¯•ä¸­æŸ¥çœ‹äº¤æ˜“æ—¥å¿—

`ic_msg!` çš„è¾“å‡ºä¼šå‡ºç°åœ¨äº¤æ˜“æ—¥å¿—ä¸­ï¼Œæµ‹è¯•ä»£ç å·²ç»æ›´æ–°ï¼Œä¼šè‡ªåŠ¨æ˜¾ç¤º CPI è°ƒè¯•æ—¥å¿—ã€‚

è¿è¡Œæµ‹è¯•ï¼š
```bash
export ANCHOR_PROVIDER_URL="http://localhost:8899"
anchor test --skip-local-validator
```

æµ‹è¯•è¾“å‡ºä¸­ä¼šæ˜¾ç¤ºï¼š
```
ğŸ” CPI Debug Logs:
  [CPI-0] Program log: [CPI DEBUG] Starting signer translation - program_id: ..., signers_seeds_len: 1
  [CPI-1] Program log: [CPI DEBUG] Derived 1 signer(s) from seeds: [...]
  [CPI-2] Program log: [SIGNER VERIFY] Account ... - is_signer in callee: true, ...
```

### æ–¹æ³• 4: å®æ—¶ç›‘æ§ï¼ˆä¸¤ä¸ªç»ˆç«¯ï¼‰

**ç»ˆç«¯ 1 - å¯åŠ¨éªŒè¯å™¨ï¼š**
```bash
./start-agave-node.sh
```

**ç»ˆç«¯ 2 - ç›‘æ§æ—¥å¿—ï¼š**
```bash
# ç›‘æ§æ ‡å‡†é”™è¯¯æ—¥å¿—
tail -f test-ledger/validator-stderr.log | grep -E "CPI DEBUG|SIGNER VERIFY"

# æˆ–è€…ç›‘æ§éªŒè¯å™¨æ—¥å¿—
tail -f test-ledger/validator.log | grep -E "CPI DEBUG|SIGNER VERIFY"
```

## æ—¥å¿—ç±»å‹è¯´æ˜

### 1. `eprintln!` æ—¥å¿—ï¼ˆæ ‡å‡†é”™è¯¯ï¼‰
- **ä½ç½®**: `test-ledger/validator-stderr.log`
- **å†…å®¹**: PDA æ´¾ç”Ÿè¿‡ç¨‹çš„è¯¦ç»†ä¿¡æ¯
- **æ ¼å¼**: `[CPI DEBUG] translate_signers_c: Signer 0 - Derived PDA: ...`

### 2. `ic_msg!` æ—¥å¿—ï¼ˆäº¤æ˜“æ—¥å¿—ï¼‰
- **ä½ç½®**: é€šè¿‡ RPC `getTransaction` è·å–ï¼Œæˆ–åœ¨æµ‹è¯•è¾“å‡ºä¸­
- **å†…å®¹**: CPI æµç¨‹å’Œ signer éªŒè¯ä¿¡æ¯
- **æ ¼å¼**: `Program log: [CPI DEBUG] ...` æˆ– `Program log: [SIGNER VERIFY] ...`

## é¢„æœŸæ—¥å¿—è¾“å‡ºç¤ºä¾‹

è¿è¡Œæµ‹è¯•åï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„æ—¥å¿—ï¼š

### æ ‡å‡†é”™è¯¯æ—¥å¿—ï¼ˆvalidator-stderr.logï¼‰
```
[CPI DEBUG] translate_signers_c: Signer 0 - Derived PDA: 9JumRPXmXF3q15nVZjxhQPDDoGhXbz6Rjh5Z5r1vMSS6 from 3 seed(s) with program_id: 42LZkBzzJUro9LPCFbg5KRLrNUXRDdrXnnrKUNeNNDrn
```

### äº¤æ˜“æ—¥å¿—ï¼ˆé€šè¿‡ RPCï¼‰
```
Program log: [CPI DEBUG] Starting signer translation - program_id: 42LZkBzzJUro9LPCFbg5KRLrNUXRDdrXnnrKUNeNNDrn, signers_seeds_len: 1
Program log: [CPI DEBUG] Derived 1 signer(s) from seeds: [9JumRPXmXF3q15nVZjxhQPDDoGhXbz6Rjh5Z5r1vMSS6]
Program log: [CPI DEBUG] Preparing instruction - program_id: TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA, num_accounts: 3, signers_count: 1
Program log: [SIGNER VERIFY] Account 9JumRPXmXF3q15nVZjxhQPDDoGhXbz6Rjh5Z5r1vMSS6 - is_signer in callee: true, is_signer in caller: false, in signers list: true, signers list: [9JumRPXmXF3q15nVZjxhQPDDoGhXbz6Rjh5Z5r1vMSS6]
Program log: [SIGNER VERIFY] Account 9JumRPXmXF3q15nVZjxhQPDDoGhXbz6Rjh5Z5r1vMSS6 signer verification PASSED
```

## æ•…éšœæ’é™¤

### é—®é¢˜ 1: çœ‹ä¸åˆ°ä»»ä½•æ—¥å¿—

**æ£€æŸ¥æ¸…å•ï¼š**
1. âœ… æ˜¯å¦é‡æ–°ç¼–è¯‘äº† agave éªŒè¯å™¨ï¼Ÿ
2. âœ… æ˜¯å¦ä½¿ç”¨äº†é‡æ–°ç¼–è¯‘çš„éªŒè¯å™¨ï¼ˆä¸æ˜¯ç³»ç»Ÿçš„ solana-test-validatorï¼‰ï¼Ÿ
3. âœ… éªŒè¯å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Ÿ
4. âœ… æ—¥å¿—æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Ÿ

**è§£å†³æ–¹æ³•ï¼š**
```bash
# 1. é‡æ–°ç¼–è¯‘
cd agave && cargo build --release

# 2. ç¡®è®¤ä½¿ç”¨çš„æ˜¯ agave éªŒè¯å™¨
cd ..
./start-agave-node.sh
# åº”è¯¥çœ‹åˆ°: "ä½¿ç”¨agaveèŠ‚ç‚¹å¯åŠ¨..."

# 3. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
ls -la test-ledger/validator-stderr.log
ls -la test-ledger/validator.log
```

### é—®é¢˜ 2: åªçœ‹åˆ°éƒ¨åˆ†æ—¥å¿—

- `eprintln!` æ—¥å¿—åœ¨ `validator-stderr.log` ä¸­
- `ic_msg!` æ—¥å¿—åœ¨äº¤æ˜“æ—¥å¿—ä¸­ï¼ˆé€šè¿‡ RPC è·å–ï¼‰

ç¡®ä¿ä¸¤ä¸ªåœ°æ–¹éƒ½æ£€æŸ¥äº†ã€‚

### é—®é¢˜ 3: æ—¥å¿—æ ¼å¼ä¸å¯¹

ç¡®ä¿ä½¿ç”¨çš„æ˜¯æœ€æ–°ç¼–è¯‘çš„éªŒè¯å™¨ï¼Œæ—§çš„éªŒè¯å™¨æ²¡æœ‰æ—¥å¿—ä»£ç ã€‚

## ç›¸å…³æ–‡ä»¶

- `agave/program-runtime/src/cpi.rs` - CPI ç›¸å…³ä»£ç å’Œæ—¥å¿—
- `agave/program-runtime/src/invoke_context.rs` - Signer éªŒè¯æ—¥å¿—
- `start-agave-node.sh` - å¯åŠ¨è„šæœ¬ï¼ˆå·²æ›´æ–°ï¼Œé‡å®šå‘ stderrï¼‰
- `view-cpi-logs.sh` - æ—¥å¿—æŸ¥çœ‹è„šæœ¬
- `tests/solana-security-audit.ts` - æµ‹è¯•ä»£ç ï¼ˆå·²æ›´æ–°ï¼Œæ˜¾ç¤º CPI æ—¥å¿—ï¼‰

