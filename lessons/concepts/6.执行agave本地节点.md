# 使用本地 Agave RPC 节点进行调试

本文档说明如何配置和使用本地 agave RPC 节点来调试 Solana 节点代码。

## 方法一：使用启动脚本（推荐）

### 1. 启动 agave 节点

```bash
# 使用默认端口（8899）
./start-agave-node.sh

# 或指定自定义端口
./start-agave-node.sh 8899 1024
```

### 2. 在另一个终端运行测试

```bash
# 使用测试脚本（会自动检查节点状态）
./run-tests-with-agave.sh

# 或手动设置环境变量后运行
export ANCHOR_PROVIDER_URL="http://localhost:8899"
anchor test --skip-local-validator
```

## 方法二：手动配置

### 1. 启动 agave 节点

如果 agave 已经构建，可以直接运行：

```bash
# 进入 agave 目录
cd agave

# 构建（如果还未构建）
cargo build --release

# 启动验证器
./target/release/solana-test-validator \
    --rpc-port 8899 \
    --reset \
    --ledger ../test-ledger
```

或者使用标准的 solana-test-validator：

```bash
solana-test-validator --rpc-port 8899 --reset
```

### 2. 配置 Anchor 使用自定义 RPC URL

设置环境变量：

```bash
export ANCHOR_PROVIDER_URL="http://localhost:8899"
```

### 3. 运行测试或部署

```bash
# 运行测试（跳过本地验证器启动，因为我们已经手动启动了）
anchor test --skip-local-validator

# 或部署程序
anchor deploy
```

## 方法三：在 Anchor.toml 中配置（如果支持）

某些版本的 Anchor 支持在 `[provider]` 部分直接设置 URL。如果您的版本支持，可以这样配置：

```toml
[provider]
cluster = "localnet"
url = "http://localhost:8899"  # 自定义RPC URL
wallet = "~/.config/solana/id.json"
```

## 调试节点代码

### 使用 GDB 调试

1. 启动 agave 节点（带调试符号）：

```bash
cd agave
cargo build --release
gdb --args ./target/release/solana-test-validator --rpc-port 8899 --reset
```

2. 在 GDB 中设置断点并运行：

```gdb
(gdb) break main
(gdb) run
```

### 使用日志调试

启动节点时启用详细日志：

```bash
RUST_LOG=debug ./target/release/solana-test-validator --rpc-port 8899 --reset
```

## 验证配置

检查 RPC 节点是否正常运行：

```bash
curl http://localhost:8899 -X POST -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"getHealth"}'
```

应该返回：`{"jsonrpc":"2.0","result":"ok","id":1}`

## 常见问题

### 1. 端口已被占用

如果端口 8899 已被占用，可以：

- 使用其他端口：`./start-agave-node.sh 8900`
- 或停止占用端口的进程：`lsof -ti:8899 | xargs kill -9`

### 2. 程序未部署

如果测试时提示程序未部署，需要先部署：

```bash
export ANCHOR_PROVIDER_URL="http://localhost:8899"
anchor deploy
```

### 3. 权限错误

如果遇到权限错误，重置验证器：

```bash
pkill -f solana-test-validator
rm -rf test-ledger
./start-agave-node.sh
```

## 环境变量说明

- `ANCHOR_PROVIDER_URL`: Anchor 使用的 RPC URL（覆盖 cluster 配置）
- `LEDGER_DIR`: 验证器数据目录（默认：./test-ledger）
- `RPC_PORT`: RPC 服务端口（默认：8899）

## 相关文件

- `Anchor.toml`: Anchor 项目配置
- `start-agave-node.sh`: 启动 agave 节点的脚本
- `run-tests-with-agave.sh`: 使用 agave 节点运行测试的脚本

