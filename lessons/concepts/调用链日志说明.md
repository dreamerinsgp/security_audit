# CPI 调用链日志说 明

## 概述

为了验证 CPI（Cross-Program Invocation）调用链路的正确性，我们在关键位置添加了日志。这些日志使用统一的格式 `[CALL CHAIN]` 前缀，方便在交易日志中识别和追踪。

## 调用链路11

```
1. solana-invoke/invoke/src/lib.rs::invoke_signed_unchecked()
   ↓ 调用 syscall
2. agave/syscalls/src/cpi.rs::SyscallInvokeSignedRust::vm()
   ↓ 路由到处理函数
3. agave/program-runtime/src/cpi.rs::cpi_common()
   ↓ 调用翻译函数
4. agave/program-runtime/src/cpi.rs::translate_signers_rust()
   ↓ 完成签名者翻译
5. 执行 CPI 调用
```

## 已添加的日志位置

### Step 1: solana-invoke (程序端)
**文件**: `/root/solana-invoke/invoke/src/lib.rs:59`
- **位置**: `invoke_signed_unchecked()` 函数中，调用 syscall 之前
- **说明**: 由于 `solana-invoke` 没有 `solana-program` 依赖，无法使用 `msg!` 宏，所以这里只添加了注释。实际的日志会在运行时捕获 syscall 调用时出现。

### Step 2: agave/syscalls (Syscall 处理层)
**文件**: `/root/agave/syscalls/src/cpi.rs:23-31`
- **位置**: `SyscallInvokeSignedRust::vm()` 函数入口
- **日志格式**: 
  ```
  [CALL CHAIN] [agave/syscalls] SyscallInvokeSignedRust::vm -> received syscall | instruction_addr: {}, account_infos_len: {}, signers_seeds_len: {}
  ```
- **作用**: 确认 syscall 已被运行时拦截并路由到处理函数

### Step 3: agave/program-runtime (CPI 通用逻辑入口)
**文件**: `/root/agave/program-runtime/src/cpi.rs:876`
- **位置**: `cpi_common()` 函数入口
- **日志格式**:
  ```
  [CALL CHAIN] [agave/program-runtime] cpi_common -> entry point | instruction_addr: {}, account_infos_len: {}, signers_seeds_addr: {}, signers_seeds_len: {}
  ```
- **作用**: 确认进入 CPI 通用处理逻辑

### Step 4: agave/program-runtime (准备调用 translate_signers)
**文件**: `/root/agave/program-runtime/src/cpi.rs:907`
- **位置**: `cpi_common()` 中，调用 `translate_signers` 之前
- **日志格式**:
  ```
  [CALL CHAIN] [agave/program-runtime] cpi_common -> calling translate_signers | caller_program_id: {}, signers_seeds_len: {}
  ```
- **作用**: 显示调用者程序 ID 和签名者种子数量

### Step 5: agave/program-runtime (translate_signers 完成)
**文件**: `/root/agave/program-runtime/src/cpi.rs:919`
- **位置**: `cpi_common()` 中，`translate_signers` 返回后
- **日志格式**:
  ```
  [CALL CHAIN] [agave/program-runtime] cpi_common -> translate_signers completed | returned {} signers: {:?}
  ```
- **作用**: 显示翻译后的签名者数量和公钥列表

### Step 6: agave/program-runtime (translate_signers_rust 入口)
**文件**: `/root/agave/program-runtime/src/cpi.rs:630`
- **位置**: `translate_signers_rust()` 函数入口
- **日志格式**:
  ```
  [CALL CHAIN] [agave/program-runtime] translate_signers_rust -> entry | program_id: {}, signers_seeds_addr: {}, signers_seeds_len: {}
  ```
- **作用**: 确认进入签名者翻译函数

### Step 7: agave/program-runtime (translate_signers_rust 完成)
**文件**: `/root/agave/program-runtime/src/cpi.rs:687-690`
- **位置**: `translate_signers_rust()` 函数返回前
- **日志格式**:
  - 成功时: `[CALL CHAIN] [agave/program-runtime] translate_signers_rust -> completed | successfully translated {} signers: {:?}`
  - 无签名者时: `[CALL CHAIN] [agave/program-runtime] translate_signers_rust -> completed | no signers to translate (signers_seeds_len = 0)`
- **作用**: 显示翻译结果

## 如何验证调用链路

### 1. 运行测试
```bash
cd /root/solana-security-audit
anchor test --skip-local-validator
```

### 2. 查看交易日志
在测试输出中查找 `[CALL CHAIN]` 前缀的日志，应该能看到以下顺序：

```
[CALL CHAIN] [agave/syscalls] SyscallInvokeSignedRust::vm -> received syscall | ...
[CALL CHAIN] [agave/program-runtime] cpi_common -> entry point | ...
[CALL CHAIN] [agave/program-runtime] cpi_common -> calling translate_signers | ...
[CALL CHAIN] [agave/program-runtime] translate_signers_rust -> entry | ...
[CALL CHAIN] [agave/program-runtime] translate_signers_rust -> completed | ...
[CALL CHAIN] [agave/program-runtime] cpi_common -> translate_signers completed | ...
```

### 3. 验证要点
- ✅ 所有步骤的日志都应该出现
- ✅ 日志顺序应该符合调用链路
- ✅ 参数值应该合理（例如 signers_seeds_len 应该匹配）
- ✅ 翻译后的签名者公钥应该正确

## 注意事项

1. **日志前缀**: 所有调用链日志都使用 `[CALL CHAIN]` 前缀，方便过滤
2. **日志级别**: 这些日志使用 `stable_log::program_log`，会出现在交易日志中
3. **性能影响**: 日志会增加少量计算开销，但有助于调试
4. **条件编译**: `solana-invoke` 中的日志只在 `target_os = "solana"` 时编译

## 相关文件

- `/root/solana-invoke/invoke/src/lib.rs` - 程序端调用
- `/root/agave/syscalls/src/cpi.rs` - Syscall 处理层
- `/root/agave/program-runtime/src/cpi.rs` - CPI 运行时逻辑
- `/root/solana-security-audit/tests/solana-security-audit.ts` - 测试文件（可添加日志过滤逻辑）

