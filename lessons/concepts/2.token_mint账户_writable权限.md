# Token Mint 账户的 Writable 权限要求

## Q1：token mint 账户要求必须可写？

**答案：取决于具体的 SPL Token 指令。**

### 需要 writable 的情况

#### 1. `mint_to` / `mint_to_checked` 指令
**必须 writable**，因为需要更新 mint 账户的 `supply` 字段。

```rust
// ❌ 错误：缺少 mut，会导致 "writable privilege escalated" 错误
pub token_mint: Account<'info, Mint>,

// ✅ 正确：添加 mut 标记
#[account(mut)]
pub token_mint: Account<'info, Mint>,
```

**原因：**
- `mint_to` 指令会修改 mint 账户的 `supply` 字段（增加代币供应量）
- Solana 运行时要求修改账户数据时，账户必须是 writable
- 如果调用者程序中账户是 readonly，但被调用者（SPL Token 程序）要求 writable，会触发权限提升错误

**错误示例：**
```
Error: Cross-program invocation with unauthorized signer or writable account
Logs: "Eo5mqpfK1c5dxkfB8eAXNPk3mBQmyD5JowSQnBiQsiFD's writable privilege escalated"
```

#### 2. `initialize_mint` 指令
**必须 writable**，因为需要初始化 mint 账户的数据。

#### 3. `set_authority` 指令（修改 mint authority）
**必须 writable**，因为需要更新 mint 账户的 `mint_authority` 字段。

### 不需要 writable 的情况

#### 1. `transfer` / `transfer_checked` 指令
**不需要 writable**，只读取 mint 账户的 `decimals` 等信息，不修改 mint 账户。

#### 2. `approve` / `approve_checked` 指令
**不需要 writable**，只修改 token account，不修改 mint 账户。

#### 3. `get_account_data_size` 等查询指令
**不需要 writable**，只读取信息。

### Solana 运行时的权限检查

根据 `agave/program-runtime/src/invoke_context.rs:388-392`：

```rust
// Readonly in caller cannot become writable in callee
if instruction_account.is_writable() && !caller_instruction_account.is_writable() {
    ic_msg!(self, "{}'s writable privilege escalated", account_key,);
    return Err(InstructionError::PrivilegeEscalation);
}
```

**规则：**
- 调用者程序中的 readonly 账户**不能**在被调用者程序中变为 writable
- 调用者程序中的 writable 账户**可以**在被调用者程序中保持 writable 或变为 readonly
- 这是 Solana 的安全机制，防止权限提升攻击

### 实际案例

在我们的 `initializeLaunch` 指令中：

```rust
#[derive(Accounts)]
pub struct InitializeLaunch<'info> {
    // ... 其他账户 ...
    
    // ✅ 必须 mut，因为后续会调用 mint_to
    #[account(mut)]
    pub token_mint: Account<'info, Mint>,
    
    // ... 其他账户 ...
}

impl<'info> InitializeLaunch<'info> {
    pub fn handle(ctx: Context<Self>, _args: InitializeLaunchArgs) -> Result<()> {
        // mint_to 需要修改 token_mint 的 supply
        token::mint_to(
            CpiContext::new_with_signer(...),
            AVAILABLE_TOKENS,
        )?;
        Ok(())
    }
}
```

### 总结

| 指令 | mint 账户是否需要 writable | 原因 |
|------|---------------------------|------|
| `mint_to` | ✅ 是 | 更新 supply |
| `mint_to_checked` | ✅ 是 | 更新 supply |
| `initialize_mint` | ✅ 是 | 初始化数据 |
| `set_authority` (mint) | ✅ 是 | 更新 authority |
| `transfer` | ❌ 否 | 只读取 decimals |
| `transfer_checked` | ❌ 否 | 只读取 decimals |
| `approve` | ❌ 否 | 不涉及 mint |
| `approve_checked` | ❌ 否 | 不涉及 mint |

### 最佳实践

1. **明确意图**：如果指令会修改 mint 账户，必须添加 `#[account(mut)]`
2. **查看文档**：不确定时，查看 SPL Token 指令的账户要求
3. **测试验证**：如果遇到 "writable privilege escalated" 错误，检查是否缺少 `mut` 标记
4. **最小权限原则**：只在需要修改时才标记为 writable，避免不必要的权限
